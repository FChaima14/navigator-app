name: Fleetbase Navigator App CI

on:
  pull_request:
    branches: [ main ]  # Trigger for PRs to main branch

jobs:
  install_and_test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - uses: actions/cache@v3
      id: npm-cache
      with:
          path: ~/.pnpm-store # Replace this with the path you want to cache
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
              ${{ runner.os }}-node-
    - name: Setup pnpm
      uses: pnpm/action-setup@v2.0.1
      with:
          version: latest

    - name: Install Node.js
      uses: actions/setup-node@v1
      with:
        node-version: 18.x

    - name: Install dependencies
      run: pnpm install

  android_build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - uses: actions/cache@v3
      id: npm-cache
      with:
          path: ~/.pnpm-store # Replace this with the path you want to cache
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
              ${{ runner.os }}-node-
    - name: Setup pnpm
      uses: pnpm/action-setup@v2.0.1
      with:
          version: latest

    - name: Install Node.js
      uses: actions/setup-node@v1
      with:
        node-version: 18.x

    - name: Install dependencies
      run: pnpm install

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'oracle' 
        java-version: '17'
        
    - name: Run Jetify
      run: npx jetify

    - name: Build Android
      run: cd android && ./gradlew && ./gradlew assembleRelease

  ios_build:
    runs-on: macOS-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - uses: actions/cache@v3
      id: npm-cache
      with:
          path: ~/.pnpm-store # Replace this with the path you want to cache
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
              ${{ runner.os }}-node-
    - name: Setup pnpm
      uses: pnpm/action-setup@v2.0.1
      with:
          version: latest

    - name: Install Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18.x

    - name: Install dependencies
      run: pnpm install

    - name: Install CocoaPods
      run: sudo gem install cocoapods

    - name: Install iOS pods
      run: cd ios && pod install

    - name: Build iOS
      run: npx react-native run-ios --configuration Release
