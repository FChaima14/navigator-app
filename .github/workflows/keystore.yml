name: Fleetbase Navigator App CI

on:
  pull_request:
    branches: [ main ]  # Trigger for PRs to main branch

env:
  FLEETBASE_KEY: ${{ secrets.FLEETBASE_KEY }}
  GOOGLE_MAPS_KEY: ${{ secrets.GOOGLE_MAPS_KEY }}
  ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
  ANDROID_RELEASE_KEYSTORE: ${{ secrets.ANDROID_RELEASE_KEYSTORE }}
  IOS_PROVISION: ${{ secrets.IOS_PROVISION }}

jobs:
  ios_build:
    runs-on: macOS-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18.x

    - name: Install dependencies
      run: npm install -g yarn

    - name: Install dependencies
      run: yarn install

    - name: Install CocoaPods
      run: sudo gem install cocoapods -v '1.14.3'

    - name: Install Algolia Gem
      run: |
        gem install algolia

    - name: Install iOS pods
      run: cd ios && pod install
    
    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
          ruby-version: '2.7.4'
          
    - name: Setup Fastlane
      working-directory: ./ios
      run: bundle install

    # - name: Build iOS app
    #   working-directory: ./ios
    #   run: xcodebuild -workspace NavigatorApp.xcworkspace -scheme NavigatorApp -sdk iphonesimulator -configuration Debug -allowProvisioningUpdates

    - name: Generate fastlane provision
      working-directory: ./ios
      run: |
        echo "$IOS_PROVISION" > Fastlane.mobileprovision.asc
        gpg -d --passphrase "$ANDROID_KEYSTORE_PASSWORD" --batch Fastlane.mobileprovision.asc > ios/Fastlane.mobileprovision.asc

    
    - name: Install Fastlane
      working-directory: ./ios
      run:  fastlane beta